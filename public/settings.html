<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sharings â€” RÃ©glages du compte</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .topbar{position:fixed;left:0;right:0;top:0;height:80px;background:rgba(255,255,255,.95);backdrop-filter:blur(18px);display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid rgba(221,221,221,.45);z-index:50}
    .logo{font-weight:900;font-size:1.35rem;background:linear-gradient(135deg,#ff385c,#667eea);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .wrap{max-width:900px;margin:120px auto 60px;padding:0 24px}
    .card{background:#fff;border:1px solid #e9e9e9;border-radius:20px;box-shadow:0 8px 36px rgba(0,0,0,.06);padding:26px}
    .muted{color:#717171}
    input,select,textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:12px;font:inherit}
    label{font-weight:700;margin:10px 0 6px;display:block}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#ff385c,#e31c5f);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:#222;border:2px solid #ddd;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">Sharings</div>
    <div style="display:flex;gap:10px">
      <a class="btn-outline" href="./dashboard.html">Dashboard</a>
      <a class="btn-outline" href="./manage-listings.html">Mes annonces</a>
      <a class="btn-outline" href="./reservations.html">RÃ©servations</a>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin-top:0">RÃ©glages du compte</h2>
      <form id="f">
        <label>Nom complet</label><input id="name" placeholder="Nom PrÃ©nom"/>
        <label>E-mail</label><input id="email" type="email" disabled/>
        <label>RÃ´le</label><select id="role"><option value="client">Client</option><option value="salon">PropriÃ©taire de salon</option></select>
        <label>Bio</label><textarea id="bio" rows="4" placeholder="Quelques mots sur vous..."></textarea>
        <div style="margin-top:12px;display:flex;gap:10px">
          <button class="btn" type="submit">ðŸ’¾ Enregistrer</button>
          <button class="btn-outline" type="button" id="logout">Se dÃ©connecter</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { sb, requireSession, toast } from "./assets/app.js";
    const supabase = sb();
    const session = await requireSession(); if(!session) throw new Error();
    const user = session.user;

    async function ensureProfile(){
      let { data: p } = await supabase.from("user_profiles").select("*").eq("user_id", user.id).maybeSingle();
      if (!p) {
        const { data } = await supabase.from("user_profiles").insert({
          user_id:user.id, email:user.email, name:user.user_metadata?.full_name||null, role:"client"
        }).select().single();
        p = data;
      }
      return p;
    }
    const p = await ensureProfile();
    name.value = p.name||""; email.value = user.email||""; role.value = p.role||"client"; bio.value = p.bio||"";

    f.addEventListener("submit", async (e)=>{
      e.preventDefault();
      await supabase.from("user_profiles").update({
        name: name.value.trim()||null, role: role.value, bio: bio.value.trim()||null
      }).eq("user_id", user.id);
      toast("âœ… Profil mis Ã  jour");
      if (role.value === "salon") location.href="./manage-listings.html";
    });

    logout.onclick = async ()=>{ await supabase.auth.signOut(); location.href="./"; };
  </script>
</body>
</html>
