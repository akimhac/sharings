<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sharings â€” GÃ©rer mes annonces</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .topbar{position:fixed;left:0;right:0;top:0;height:80px;background:rgba(255,255,255,.95);backdrop-filter:blur(18px);display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid rgba(221,221,221,.45);z-index:50}
    .logo{font-weight:900;font-size:1.35rem;background:linear-gradient(135deg,#ff385c,#667eea);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .wrap{max-width:1100px;margin:120px auto 60px;padding:0 24px}
    .card{background:#fff;border:1px solid #e9e9e9;border-radius:20px;box-shadow:0 8px 36px rgba(0,0,0,.06);padding:26px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:24px}
    .row{display:flex;justify-content:space-between;gap:12px;padding:14px;border:1px solid #efefef;border-radius:14px}
    .muted{color:#717171}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,#ff385c,#e31c5f);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:#222;border:2px solid #ddd;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer}
    input,select,textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:12px;font:inherit}
    label{font-weight:700;margin:10px 0 6px;display:block}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">Sharings</div>
    <div style="display:flex;gap:10px">
      <a class="btn-outline" href="./dashboard.html">Dashboard</a>
      <a class="btn-outline" href="./reservations.html">RÃ©servations</a>
      <a class="btn-outline" href="./">Accueil</a>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2 style="margin-top:0">Mes annonces</h2>
        <div id="list" style="display:flex;flex-direction:column;gap:12px"></div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Nouvelle annonce</h3>
        <form id="f">
          <label>Titre</label><input id="title" required/>
          <label>Ville</label><input id="city" required/>
          <label>Prix / jour (â‚¬)</label><input id="price" type="number" min="0" step="1" value="50" required/>
          <label>Statut</label><select id="status"><option value="publiee">PubliÃ©e</option><option value="brouillon">Brouillon</option></select>
          <label>Description</label><textarea id="desc" rows="4"></textarea>
          <div style="margin-top:12px;display:flex;gap:10px">
            <button class="btn" type="submit">ðŸ’¼ Enregistrer</button>
            <button class="btn-outline" type="reset">RÃ©initialiser</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { sb, requireSession, toast } from "./assets/app.js";
    const supabase = sb();
    const session = await requireSession(); if(!session) throw new Error();
    const user = session.user;

    async function load() {
      const { data, error } = await supabase
        .from("annonces")
        .select("id,title,city,price_per_day,status,created_at")
        .eq("owner_id", user.id).order("created_at",{ascending:false});
      const el = document.getElementById("list");
      el.innerHTML = error ? `<div class="muted">Erreur: ${error.message}</div>`
        : (data?.length ? "" : "<div class='muted'>Aucune annonce.</div>");
      (data||[]).forEach(a=>{
        const row = document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <div>
            <div style="font-weight:800">${a.title}</div>
            <div class="muted">${a.city} Â· ${a.price_per_day??"-"}â‚¬ Â· ${(a.status||"").toUpperCase()}</div>
          </div>
          <div style="display:flex;gap:8px">
            <a class="btn-outline" href="./reservations.html?listing=${a.id}">RÃ©servations</a>
            <button class="btn-outline" data-edit="${a.id}">Modifier</button>
            <button class="btn-outline" data-del="${a.id}">Supprimer</button>
          </div>`;
        el.appendChild(row);
      });
      el.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{
        if(!confirm("Supprimer cette annonce ?"))return;
        await supabase.from("annonces").delete().eq("id", b.dataset.del).eq("owner_id", user.id);
        toast("SupprimÃ©"); load();
      });
      el.querySelectorAll("[data-edit]").forEach(b=>b.onclick=async()=>{
        const { data } = await supabase.from("annonces").select("*").eq("id", b.dataset.edit).single();
        if(!data) return;
        f.dataset.edit=data.id;
        title.value=data.title||""; city.value=data.city||""; price.value=data.price_per_day||0;
        status.value=data.status||"brouillon"; desc.value=data.description||"";
        window.scrollTo({top:0,behavior:"smooth"});
      });
    }

    const f = document.getElementById("f");
    const title = document.getElementById("title"); const city = document.getElementById("city");
    const price = document.getElementById("price"); const status = document.getElementById("status");
    const desc  = document.getElementById("desc");

    f.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const payload={owner_id:user.id,title:title.value.trim(),city:city.value.trim(),
        price_per_day:Number(price.value),status:status.value,description:desc.value.trim()||null};
      if(f.dataset.edit){ await supabase.from("annonces").update(payload).eq("id",f.dataset.edit).eq("owner_id",user.id); f.dataset.edit=""; }
      else { await supabase.from("annonces").insert(payload); }
      f.reset(); toast("âœ… EnregistrÃ©"); load();
    });

    await load();
  </script>
</body>
</html>
